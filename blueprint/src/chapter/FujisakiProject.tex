\chapter{Miniproject: Fujisaki's Lemma}\label{Fujisaki_project}

\section{The goal}

There is an idelic compactness statement which encapsulates both finiteness of the class
group of a number field and Dirichlet's units theorem about the rank of the unit group.
In fact there is even a noncommutative version of this statement. In John Voight's
book~\cite{voightbook} this is Main Theorem 27.6.14(a) and Voight calls it Fujisakiâ€™s lemma.
I know nothing of the history but I'm happy to adopt this name. In the quaternion algebra
miniproject we will use this compactness result to prove finite-dimensionality of a
space of quaternionic modular forms.

\section{Initial definitions}

Let $K$ be a field. A \emph{central simple $K$-algebra} is a $K$-algebra~$B$ (not necessarily
commutative) with centre $K$ such that $B$ has exactly two two-sided ideals, namely ${0}$ and $B$
(or $\bot$ and $\top$, as Lean would call them). We will be concerned
only with central simple $K$-algebras which are finite-dimensional as $K$-vector spaces, and
when $K$ is clear we will just refer to them as central simple algebras. We remark that a
4-dimensional central simple algebra is called a \emph{quaternion algebra}; we will have
more to say about these later on.

Matrix algebras $M_n(K)$ are examples of finite-dimensional central simple $K$-algebras.
If $K=\bbC$ (or more generally if $K$ is algebraically closed)
then matrix algebras are the only finite-dimensional examples
up to isomorphism. There are other examples over the reals: for example Hamilton's quaternions
$\bbH:=\R\oplus\R i\oplus\R j\oplus\R k$ with the usual rules $i^2=j^2=k^2=-1$,
$ij=-ji=k$ etc, are an example of a central simple $\R$-algebra (and a quaternion algebra), and
matrix algebras over $\bbH$ are other central simple $\R$-algebras.
For a general field $K$
one can make an analogue of Hamilton's quaternions $K\oplus Ki\oplus Kj\oplus Kk$ with the
same multiplication rules ($i^2=-1$ and so on) to describe the multiplication, and if the characteristic
of~$K$ isn't 2
then this is a quaternion algebra (which may or may not be isomorphic to $M_2(K)$ in this
generality).

Some central simple algebras~$B$ are \emph{division algebras}, meaning that they are division
rings, or equivalently that every nonzero $b\in B$ has a two-sided inverse. For example
Hamilton's quaternions are a division algebra over $\R$,
because $(x+yi+zj+tk)(x-yi-zj-tk)=x^2+y^2+z^2+t^2$, so the inverse
of a nonzero $x+yi+zj+tk$ is $(x-yi-zj-tk)/(x^2+y^2+z^2+t^2)$.
However $2\times 2$ matrices over a field~$K$, whilst being a central simple algebra
over~$K$, are never a division algebra
(even if $K=\bbC$) because a nonzero matrix with determinant zero such as
$\begin{pmatrix}1&0\\0&0\end{pmatrix}$ has no inverse.

\section{Enter the adeles}

The adeles of a number field are discussed in far more detail
in the adele miniproject \ref{Adele_miniproject}. We just recall here that if $K$ is a number field
then there are two huge commutative topological $K$-algebras called the \emph{finite adeles}
$\A_K^\infty$ and the \emph{adeles} $\A_K$ of $K$, and that they're both locally compact
as topological spaces. We also know from theorem~\ref{NumberField.AdeleRing.baseChangeEquiv}
that $\A_K\cong K\otimes_{\Q}\A_{\Q}K$ (both topologically and algebraically), meaning
that if $R$ is a $K$-algebra then $R_{\A} := R\otimes_K\A_K$ is naturally isomorphic
to $R\otimes_{\Q}\A_{\Q}$. One can
furthermore check that if $R$ is a finite $K$-algebra then the $\A_K$-module topologies and $\A_{\Q}$-module
topologies on $R_{\A}$ coincide. Indeed, the topology on $\A_K$
is the $\A_{\Q}$-module topology, as
$\A_K=\A_{\Q}\otimes_{\Q}K$ as topological $\A_{\Q}$-algebras, where the right hand side
has the $\A_{\Q}$-module topology by definition. So the claim follows from the
fact that if $A$ is a topological ring, $B$ is a topological $A$-algebra
finite as an $A$-module and with the $A$-module topology, and if
$M$ is a topological $B$-module
(and hence a topological $A$-module), then the $A$-module and $B$-module
topologies on~$M$ coincide (this is {\tt moduleTopology.trans} in the repo,
not yet PRed to mathlib).

Let $K$ be a number field and let $D/K$ be a finite-dimensional central simple $K$-algebra
(later on $D$ will be a division algebra (hence the name) but we do not need this yet).
Then $D_{\A}:=D\otimes_K\A_K$ is an $\A_K$-algebra which
is free of finite rank, and if we give $D_{\A}$ the $\A_K$-module topology then it is
a topological ring (by results in mathlib). Furthermore $D_{\A}$ is free of finite
rank over the locally compact topological ring $\A_K$ and is thus also
locally compact. So by the theory of Haar characters (see Chapter~\ref{Haar_char_project})
there is a canonical character $\delta_{D_{\A}}:D_{\A}^\times\to\R_{>0}$ measuring
how left multiplication by an element of $D_{\A}^\times$ changes the additive Haar
measure on $D_{\A}$. Let $D_{\A}^{(1)}$ denote the kernel of $\delta_{D_{\A}}$,
and give it the subspace topology coming from $D_{\A}^\times$.
Corollary~\ref{NumberField.AdeleRing.units_mem_ringHaarCharacter_ker} from the
Haar character miniproject shows that $D^\times$ (regarded as a subgroup of $D_{\A}^\times$
via the map $d\mapsto d\otimes 1$) is contained within $D_{\A}^{(1)}$,
thus the below theorem typechecks.

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.compact_quotient}

The rest of this miniproject is devoted to a proof of this theorem.

\section{The proof}

We prove the theorem via a series of lemmas.

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.existsE}



\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.E}

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.X}

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.Y}

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.X_compact}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.Y_compact}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.X_meets_kernel}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.X_meets_kernel'}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.T}

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.T_finite}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.C}

\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.C_compact}


\inputleannode{NumberField.AdeleRing.DivisionAlgebra.Aux.antidiag_mem_C}


We can now prove Fujisaki's theorem~\ref{NumberField.AdeleRing.DivisionAlgebra.compact_quotient}.



We note here some useful consequences.

\inputleannode{NumberField.FiniteAdeleRing.DivisionAlgebra.units_cocompact}

\begin{remark} In this generality the quotient might not be Hausdorff.
\end{remark}

\inputleannode{NumberField.FiniteAdeleRing.DivisionAlgebra.finiteDoubleCoset}

