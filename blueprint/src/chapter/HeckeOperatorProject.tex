\chapter{Miniproject: Hecke Operators}\label{HeckeOperator_project}

\section{Status}

This is an active miniproject. The abstract theory is completely formalized;
at the time of writing the concrete theory has no sorried definitions
but it does have some sorried proofs.

\section{The goal}

The goal of this project is to get sorry-free definitions of Hecke operators
acting on spaces of automorphic forms. These Hecke operators generate
Hecke algebras, which are the rings called $T$ in the modularity lifting theorems,
or $R=T$ theorems, crucially introduced by Wiles in order to prove FLT.

The theory comes in two parts;
the ``abstract'' theory, which is pure algebra, and the ``concrete'' theory
where we apply the abstract constructions to produce endomorphisms of
spaces of automorphic forms. The abstract theory is short (and completely formalized);
the concrete theory still needs some work because to apply the theory to the
adelic groups we care about we need to develop some more API around the theory
of restricted products, and of compact open subgroups of matrix groups.

\section{The abstract theory}

\subsection{Introduction}

The set-up: we have a commutative ring $R$, the coefficient ring, and
all of our spaces which the operators act on will be $R$-modules.

We have a group $G$ acting $R$-linearly on an $R$-module $A$.

We have subgroups $U$ and $V$ of $G$.
We will be particularly interested in the $R$-modules $A^U$ and $A^V$
of invariant elements.

Given an element $g\in G$, then under a certain finiteness hypothesis
we will be able to define an $R$-linear map $T_g$ or $[UgV]$
from $A^V$ to $A^U$. The finiteness hypothesis is that the
double coset $UgV$ can be written as a \emph{finite} union of single
cosets $g_iV$.

\inputleannode{AbstractHeckeOperator.HeckeOperator_toFun}

\inputleannode{AbstractHeckeOperator.HeckeOperator}


The group $G$ is not in general commutative, and hence if $U=V$
the Hecke operators in this generality do not in general commute
as endomorphisms of $A^U$. Here is a criterion for
them to commute.

\inputleannode{AbstractHeckeOperator.comm}


The finiteness hypothesis that the decomposition $UgV=\coprod_i g_iV$ is
into a finite union is necessary for the theory to work. If $G$ is a topological
group then here is a criterion which gives the finiteness hypothesis for free.

\inputleannode{QuotientGroup.mk_image_finite_of_compact_of_open}


\section{Restricted products}

In the concrete example of Hecke operators which we care about, the invariants $A^G$
will be spaces of quaternionic automorphic
forms (by definition). We do not need to worry about the definition of $A$ in this
project at all. However we will need to do various computations with the
specific groups $G$ which we are interested in, and they are restricted products.
So we now develop some theory for restricted products,
starting by recalling the definition.

If $I$ is an index set, if $X_i$ are sets indexed by $i\in I$ and if $Y_i$
are subsets, then the \emph{restricted product} $\prod'_iX_i$ (note the dash) is defined
to be the subset of the full product $\prod_i X_i$ consisting of those
tuples $(x_i)$ such that $x_i\in Y_i$ for all but finitely many~$i$. We suppress
the $Y_i$ from the notation in this document, although in Lean we cannot do this and
the restricted product looks something like $\prod{}^{r} i,[X\ i, Y\ i]$.

It is straightforward to check that if the $X_i$ are groups or rings or $R$-modules,
and the $Y_i$ are subgroups or subrings or submodules, then the restricted product
is a group, ring or $R$-module; indeed the structure is inherited via the
inclusion $\prod'_iX_i\subseteq\prod_iX_i$ (and the fact that arbitrary products
of groups/rings/modules are groups/rings/modules).

More subtle is the theory of topological space structures. If the $X_i$
are topological spaces then we do \emph{not} give $\prod'_iX_i$ the subspace
topology coming from the product topology on $\prod_iX_i$; instead we give
it the finest topology making all of the
natural maps $\prod_{i\in S}X_i\times\prod_{i\notin S}Y_i\to \prod'_iX_i$ continuous,
as $S$ runs through all finite subsets of~$I$; here the product of $X_i$s and $Y_i$s
has the product topology. For example if all of the $Y_i$ are open
then one can check that $\prod_iY_i$ is an open subset of
$\prod'_iX_i$ (this is {\tt RestrictedProduct.isOpen\_forall\_mem} in mathlib),
whereas it is not of the form $\left(\prod'_iX_i\right)\cap U$ for any open subset~$U$
of $\prod_iX_i$ in general; the map from $\prod'_i X_i$ to $\prod_i X_i$ is continuous
but is not in general an embedding.

If you've seen automorphic forms before, then here is an obvious-sounding claim:
because the adeles $\mathbb{A}_F$ of a number field are a restricted product of
completions $F_v$ with respect to the integer rings $\mathcal{O}_v$, then
$GL_2(\mathbb{A}_F)$ is obviously topologically a restricted product of
$GL_2(F_v)$ with respect to $GL_2(\mathcal{O}_v)$. We now spend some time justifying
this claim, which is a little more intricate than it sounds.

\subsection{Products}

Here are some basic facts we need about restricted products.

\inputleannode{Homeomorph.restrictedProductProd}
\begin{remark} This may well not be true if $B_i$ and $D_i$ are not open, because
  filtered colimits and binary products do not appear in general to commute
  in the category of topological spaces. I don't know an explicit counterexample though.
\end{remark}


\inputleannode{Homeomorph.restrictedProductPi}


 Let $n$ be a natural and let $M_n(X)$ for a set $X$ denote ``$n\times n$
  matrices with coefficient in $X$'', i.e. $X^{n^2}$. If $X$ is a topological
  spaces then give $M_n(X)$ the product topology.

\inputleannode{Homeomorph.restrictedProductMatrix}


\subsection{Units}

We now want to move from matrices to invertible matrices whilst keeping track of topology,
so we need to understand units of topological monoids. Openness of the subobject was
crucial in the above arguments, so we need the next lemma before we can get anywhere.

\inputleannode{Submonoid.units_isOpen}
\begin{remark} Note that $M^\times$ doesn't get the subspace topology from~$M$,
  it is embedded into $M\times M$ via $g\mapsto (g,g^{-1})$ and gets the subspace
  topology from the product. This makes it into a topological group.
\end{remark}


Later on, compactness will be key for us, so we record the analogous result
for compactness.

\inputleannode{Submonoid.units_isCompact}
\begin{remark} Is Hausdorffness necessary?
\end{remark}


\inputleannode{ContinuousMulEquiv.piUnits}


\inputleannode{ContinuousMulEquiv.restrictedProductUnits}


\section{Some local theory}

We could work over a general nonarchimedean normed field but we still do not have them
in mathlib, so we stick to the case of interest which is the completion of a number
field~$K$ at a finite place~$v$. Such a completion is a topological field~$K_v$
equipped with a discrete valuation, a ring of integers $\calO_v$ having a principal
maximal ideal $(\varpi)$, and a finite residue field $k_v:=\calO_v/(\varpi)$.

There is no formal Lean code for the lemmas in this section; I am slightly dragging my
feet because it would seem more sensible to prove them in the right generality,
and we don't have a definition of nonarchimedean local field yet.

\inputleannode{NumberField.isOpenAdicCompletionIntegers}


\inputleannode{NumberField.instCompactSpaceAdicCompletionIntegers}


\inputleannode{M2.localFullLevel.isOpen}


\inputleannode{M2.localFullLevel.isCompact}


\begin{lemma} $GL_2(\calO_v)$ is a compact open subgroup of $GL_2(K_v)$.
  \label{nolean-compactopen-GL2}
\end{lemma}
\begin{proof}
  \uses{nolean-compactopen-matrix, Submonoid.units_isOpen, Submonoid.units_isCompact}
  $K_v$ is known to be Hausdorff, so $M_2(K_v)$ is Hausdorff and the
  results follow from lemmas~\ref{Submonoid.units_isOpen} and~\ref{Submonoid.units_isCompact}.
\end{proof}

Recall that there is a projection $\calO_v\to k_v$ where $k_v$ is the residue
field of~$v$, a finite field. This induces a ring homomorphism $M_2(\calO_v)\to M_2(k_v)$
with kernel $M_2(\varpi\calO_v)$, an ideal~$I$ of $M_2(\calO_v)$ isomorphic to $(\varpi\calO_v)^4$
and hence also compact and open.

Say $\Gamma_v$ is a subgroup of $GL_2(k_v)$. Then $\Gamma_v$ is finite. Consider it as a submonoid of
the multiplicative monoid $M_2(k_v)$. Its preimage~$U_v$ in $M_2(\calO_v)$
is easily checked to be a submonoid of $M_2(\calO_v)$; furthermore it is a finite union of
cosets of $I$ and is hence compact and open as a submonoid of $M_2(\calO_v)$ and hence of $M_2(K_v)$.

\begin{lemma}
  \label{nolean-compactopen-U1p} $U_v$ is a compact open subgroup of $GL_2(K_v)$.
\end{lemma}
\begin{proof}
  \uses{Submonoid.units_isOpen, Submonoid.units_isCompact}
  $\Gamma_v$ is a group and hence its preimage $U_v$ is a subgroup of the monoid
  $M_2(K_v)$. It is compact and open as we just saw. Hence its units (also $U_v$)
  are a subgroup of $GL_2(K_v)$, which is compact and open, again by
  lemmas~\ref{Submonoid.units_isOpen} and~\ref{Submonoid.units_isCompact}.
\end{proof}

Say now $\begin{pmatrix}1&*\\0&1\end{pmatrix}\subseteq\Gamma_v\subseteq\begin{pmatrix}*&*\\0&*\end{pmatrix}$
and let $U:=U_v$ be its preimage in $GL_2(\calO_v)$, considered as a compact open subgroup of $GL_2(K_v)$.
Choose $0\not=\alpha\in\calO_v$ and define $g=\begin{pmatrix}\alpha&0\\0&1\end{pmatrix}\in GL_2(K_v)$.
Let's do an explicit double coset decomposition in preparation for a calculation with Hecke operators.

\inputleannode{bijOn_unipotent_mul_diagU1_U1diagU1}


\section{Adelic groups}

We are finally ready to discuss the group~$G$ and the subgroups~$U$ which we will be
using to define our Hecke operators. Let~$K$ be a number field, let~$D$ a quaternion algebra
over~$K$ and let $\A_K^\infty$ be the finite adeles of~$K$; recall that this is a commutative
topological ring, defined to be the restricted
product of the commutative topological fields~$K_v$ as $v$ runs through the finite places
of~$K$, with respect to the compact open subrings $\calO_v$.

The group~$G$ we are interested in for the rest of this miniproject is the group
$(D\otimes_K\A_K^\infty)^\times$. We want to write down compact open subgroups of this group,
but the first thing we need to do is to find a way of talking about elements of the group.

We will assume that there exists an $\A_K^\infty$-algebra isomorphism
$D\otimes_K\A_K^\infty=M_2(\A_K^\infty)$ and we will fix such an isomorphism $r$
(called a \emph{rigidification} in the Lean code). We give both of these $\A_K^\infty$-algebras
the $\A_K^\infty$-module topology, which is a fancy way of saying the product topology
(they are both free of rank 4 as $\A_K^\infty$-modules); the rigidification is then
a homeomorphism (because all $\A_K^\infty$-module maps between modules with the $\A_K^\infty$-module
topology are continuous).

This means that our group~$G$ is isomorphic (both algebraically and topologically)
to $GL_2(\A_K^\infty)$. Before we go any further,
let say something about matrix rings over complete fields.

\inputleannode{GL2.restrictedProduct}


If~$S$ is a finite set of finite places of~$K$, and for each $v\in S$ we choose
a subgroup $\Gamma_v$ of $GL_2(k_v)$ then we saw in the previous section how to
create a compact open subgroup $\tilde{\Gamma}_v$ of $GL_2(K_v)$. For $v\notin S$
define $\tilde{\Gamma}_v=GL_2(\calO_v)$. Then $\prod_v\tilde{\Gamma}_v$ is a compact
open subgroup of $\prod_vGL_2(\calO_v)$. It is compact subgroups of this form
which we shall be using.

\section{Automorphic forms}

We recall some of the definitions of spaces of automorphic forms, from
the quaternion algebra project, section~\ref{Quat_alg_project}.

We fix a totally real field~$F$, a
totally definite quaternion algebra~$D/F$, and a coefficient (additive abelian) group~$R$.
Set $G=(D\otimes_F\A_F^\infty)^\times$ as in the previous section. Note that $G$
naturally contains copies of $D^\times$ and $(\A_F^\infty)^\times$. Recall from
definition~\ref{TotallyDefiniteQuaternionAlgebra.WeightTwoAutomorphicForm}
that an $R$-valued weight~2 automorphic form
is a function $f:G\to R$ satisfying the following axioms:
\begin{enumerate}
  \item $f(dg)=f(g)$ for all $d\in D^\times\subseteq(D\otimes_F\A_F^\times)$;
  \item There exists a compact open subgroup of~$U$ (the \emph{level} of~$f$)
    such that $f(gu)=f(g)$ for all $g\in G$ and $u\in U$;
  \item $f(gz)=f(g)$ for all $z\in(\A_F^\infty)^\times$.
\end{enumerate}

It can be checked that the collection of all such forms is an additive abelian group,
and if~$R$ is a ring then it is naturally an~$R$-module. Let's call this group~$A$ for short.
Then~$A$ has a left action of $G$, with $g\cdot f$
defined via $(g\cdot f)(x):=f(xg)$. Recall from
definition~\ref{TotallyDefiniteQuaternionAlgebra.WeightTwoAutomorphicFormOfLevel}
that a weight 2 automorphic form of level~$U$ is simply an element of the
fixed points $A^U$. In other words, the forms of level~$U$ are the forms satisfying the three axioms
defining an automorphic form but with the compact open subgroup in the second
axiom being~$U$.

\section{Concrete Hecke operators}

Let~$F$ be a number field. For each finite place $v$ we have the completion $F_v$ of $F$ at $v$,
which is a normed field equipped with its integer ring $\calO_v$, a local ring with
finite residue field~$k_v$.

For $v$ a finite place of~$F$, let $\Delta_v$ be a subgroup of $k_v^\times$ and consider
the subgroup $\Gamma_v$ of $GL_2(k_v)$ consisting of matrices $\begin{pmatrix}a&b\\0&d\end{pmatrix}$
with $a,d\in k_v^\times$ and $a/d\in\Delta_v$. Then

It is easily checked that this is a subgroup, and that
$\begin{pmatrix}1&*\\0&1\end{pmatrix}\subseteq\Gamma_v\subseteq\begin{pmatrix}*&*\\0&*\end{pmatrix},$
so lemma~\ref{nolean-U1-coset-decomposition} applies.
Let $U_{\Delta_v}$ be the preimage of this subgroup in $GL_2(\calO_v)$.
This is a compact open subgroup of $GL_2(\calO_v)$, by the remarks above.

Let~$S$ be a finite set of finite places of~$F$, and define $U_\Delta(S)$ to be the matrices
in $\prod_v GL_2(\calO_v)$ which are in $U_{\Delta_v}$ for all $v\in S$ (we put no condition
at the places $v\notin S$). We can consider
$U_{\Delta}(S)$ as a subgroup of $GL_2(\A_F^\infty)$; it is a product of compact subgroups
and thus compact, and it is a product of opens all but finitely many of which are $GL_2(\calO_v)$
and is thus open. Because the inclusion $\prod_v GL_2(\calO_v)\to GL_2(\A_F^\infty)$ is an
open embedding, we can regard $U_\Delta(S)$ as a compact open subgroup of $GL_2(\A_F^\infty)$.

If we fix $r$ a rigidification, it
induces an isomorphism $GL_2(\A_F^\infty)=(D\otimes_F\A_F^\infty)^\times$
and so we can identify~$U_\Delta(S)$ with its image in $(D\otimes_F\A_F^\infty)$.

We introduce Hecke operators of two types.

First, for $v$ any place not in~$S$ we choose a uniformiser $\varpi_v\in F_v$,
form the invertible $2\times 2$ matrix $\begin{pmatrix}\varpi_v&0\\0&1\end{pmatrix}\in GL_2(F_v)$
and extend this element to an element $g\in G$ by letting its component at all finite places
$w\not=v$ be the identity. We define the Hecke operator $T_v:A^U\to A^U$ to be $[UgU]$, using the
notation defined at the beginning of this section.

For the second kind of Hecke operator we choose
$0\not=\alpha\in\calO_v$ and we consider the $2\times 2$ matrix in $GL_2(\A_K^\infty)$
which is $\begin{pmatrix}\alpha&0\\0&1\end{pmatrix}$ at~$v$ and 1 at all other local components.
Via the rigidification~$r$ we obtain an element $g\in G$.
We define the Hecke operator $U_{v,\alpha}$ to be $[UgU]$.

The Hecke algebra of interest to us will be generated by the Hecke operators $T_v$ for $v\notin S$
and $U_{v,\alpha}$ for $v\in S$.

The big theorem we want in this section is
\begin{theorem}
  \label{nolean-hecke-algebra-commutative-noetherian}
  Say~$R$ is a Noetherian ring. Then the subalgebra of the $R$-linear endomorphisms
  of $A^U$ generated by the Hecke operators $T_v$ for $v\notin S$ and $U_{v,\alpha}$ for $v\in S$
  is a Noetherian commutative ring.
\end{theorem}

\section{Analysis of the Hecke algebra}

First we discuss commutativity of the Hecke operators. First, assume that $v\not\in S$.
Then $U=GL_2(\calO_v)\times U'$ where $U'$ is a subgroup of the restricted product
of $GL_2(F_w)$ for $w\not=v$. We can use {\tt RestrictedProduct.SubmonoidClass.isProductAt} to express this
concept of being an internal direct product. If $g$ is the element of $G$ used to make $T_v$ then
$g$ is also supported at $w$, so the double coset space $UgU$ is just
$(GL_2(\calO_v)\begin{pmatrix}\varpi&0\\0&1\end{pmatrix}GL_2(\calO_v))\times U'$
and in particular can be decomposed into single left $U$-cosets of the form $g_iU$
where $g_i$ is also supported at~$v$. This is {\tt RestrictedProduct.mem\_coset\_and\_mulSupport\_subset\_of\_isProductAt}.

Similarly if $v\in S$, if $0\not=\alpha\in\calO_v$ and if $g_v=\begin{pmatrix}\alpha&0\\0&1\end{pmatrix}$
and is 1 elsewhere, then the double coset space $UgU$ can again be written as $\coprod_i g_iU$
with the $g_i$ supported only at~$v$.

We deduce immediately from lemma~\ref{AbstractHeckeOperator.comm} that two Hecke operators
associated to different finite places of~$F$ commute.
What remains is to check that $U_{\alpha,v}$ and $U_{\beta,v}$ commute. In fact we claim
more, namely that $U_{\alpha,v}U_{\beta,v}=U_{\alpha\beta,v}$. This will suffice
because $\alpha\beta=\beta\alpha$.

\begin{lemma}
  \label{nolean-product-of-U-alpha}
  If $v\in S$ and $\begin{pmatrix}1&*\\0&1\end{pmatrix}\subseteq\Gamma_v\subseteq\begin{pmatrix}*&*\\0&*\end{pmatrix}$
  then $U_{\alpha,v}U_{\beta,v}=U_{\alpha\beta,v}$.
\end{lemma}
\begin{proof} Follows easily from the explicit double coset decomposition proved above.
\end{proof}

The reason that the Hecke algebra is Noetherian is that the main theorem of the Fujisaki
miniproject immediately implies that $A^G$ is a submodule of a finite free $R$-module
and is hence Noetherian. Its endomorphism algebra is hence a Noetherian $R$-module,
so the sub-$R$-algebra generated by the Hecke operators is also a Noetherian $R$-module
and thus a Noetherian ring.
